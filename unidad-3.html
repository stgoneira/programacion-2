<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Unidad 3 - Programación II</title>

		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/reset.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/reveal.min.css" />
		
		<!-- otros themes: https://revealjs.com/themes/ Ejemplos: black, white, league, beige, sky, night, serif, simple, solarized, blood, moon -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/theme/white.min.css" />
		<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/theme/blood.min.css" /> -->

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/plugin/highlight/monokai.min.css" />
		
		<link rel="stylesheet" href="estilo.css" />
		
		<!-- plugin notación matemática -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/plugin/math/math.min.js"></script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-separator="^---$" data-separator-vertical="^===$" data-separator-notes="^Note:" data-markdown data-line-numbers>
    				<textarea data-template>
## [Unidad 3](#)
### Programación II
	
---
## [Temas](#)

- SQLite
- Ubicación

---
## [SQLite](#)

Puedes usar 2 formas de trabajo:

1. [ROOM (recomendada)](https://developer.android.com/training/data-storage/room)
2. [SQLiteOpenHelper](https://developer.android.com/training/data-storage/sqlite)

===
## [ROOM](#)

- Librería tipo ORM
- Hacen fácil la creación de la BD y tablas
- También facilitan las consultas a través de una interfaz DAO

===
## [Corrutinas](#)

- Solo disponibles en Kotlin, NO en Java
- Hacen fácil la programación asincrónica 
- Evitan que se bloquee el hilo principal de Android 
- Y por tanto mejoran la experiencia del usuario

===
## [Implementación](#)

1. Agregar Dependencias
1. Agregar [plugin KSP](https://developer.android.com/build/migrate-to-ksp)
1. Definición Entidad <!-- .element class="fragment" -->
1. Definición Interfaz DAO <!-- .element class="fragment" -->
1. Definición de Convertidores (opcional) <!-- .element class="fragment" -->
1. Definición Base de Datos <!-- .element class="fragment" -->

===
## [Dependencias](#)

```kotlin
dependencies {
	// ROOM
	val room_version = "2.6.1"
	implementation("androidx.room:room-runtime:$room_version")
	annotationProcessor("androidx.room:room-compiler:$room_version")
	ksp("androidx.room:room-compiler:$room_version")
	implementation("androidx.room:room-ktx:$room_version")
	
	// otras dependencias
}
```

===
## [KSP](#)

1. Incluir plugin con versión en build.gradle.kts
2. Incluir plugin en build.gradle.kts (:app) 
3. Alinear versión de KSP con versión de Kotlin


- [Documentación KSP](https://developer.android.com/build/migrate-to-ksp)
- [Versiones de KSP](https://github.com/google/ksp/tags)

===
## [Dependencias y KSP](#)

<iframe width="560" height="315" src="https://www.youtube.com/embed/Zune7PuT77Q?si=GXBl09wPh-yIEN4L" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

===
## [Entidad](#)

```kotlin[]
@Entity
data class Gasto(
    @PrimaryKey(autoGenerate = true) var id:Long? = null,
    var monto:Long,
    var fecha: LocalDate,
    var categoria: String,
    var descripcion: String
)
```

===
## [DAO](#)

```kotlin[]
@Dao
interface GastoDao {

    @Query("SELECT * FROM Gasto ORDER BY fecha DESC")
    suspend fun obtenerTodos(): List<Gasto>

    @Query("SELECT * FROM Gasto WHERE id = :id")
    suspend fun obtenerPorId(id:Long): Gasto

    @Insert
    suspend fun insertar(gasto:Gasto)

    @Update
    suspend fun modificar(gasto:Gasto)

    @Delete
    suspend fun eilminar(gasto:Gasto)
}
```

===
## [Converters](#)

```kotlin[]
class LocalDateConverter {
    @TypeConverter
    fun fromTimestamp(value: Long?): LocalDate? {
        return value?.let { LocalDate.ofEpochDay(it) }
    }

    @TypeConverter
    fun dateToTimestamp(date: LocalDate?): Long? {
        return date?.toEpochDay()
    }
}
```

===
## [Database](#)

```kotlin[]
@Database(entities = [Gasto::class], version = 1)
@TypeConverters(LocalDateConverter::class)
abstract class BaseDatos : RoomDatabase() {
    abstract fun gastoDao(): GastoDao
}
```

===
## [Entidades, DAO y BD](#)

<iframe width="560" height="315" src="https://www.youtube.com/embed/9Cj-DnNNb30?si=tbGCMdMmuk0TNfPu" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

===
## [Uso de ROOM con ViewModels](#)

<iframe width="560" height="315" src="https://www.youtube.com/embed/8rNeHnVa6SQ?si=KPdFgShFWEUpIZHe" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

---
## [Ubicación](#)

- Es posible conseguir la [ubicación del dispositivo](#) móvil
- Se recupera en forma de [latitud y longitud](#) 
- La forma recomendada es usando [Google Play Services](#) 
- También se puede recuperar la ubicación usando [LocationManager](#)

===
## [Latitud y Longitud](#)

- [Coordenadas geográficas](#) para especificar la ubicación de un punto
- La latitud mide la distancia al [norte o al sur del ecuador](#)
- La longitud mide la distancia al [este o al oeste del meridiano de Greenwich](#)
- Se mide en [grados, minutos y segundos](#) 
- Se puede [transforma a un número decimal](#)

===
## Latitud y Longitud
<!-- .element style="color: white;" -->

![Latitud y Longitud](img/ppt/lat-y-long.webp)
<!-- .element style="height: 600px;" -->

===
## [Conversión a decimal](#)

`$$
\text{{Decimal}} = \text{{grados}} + \left(\frac{{\text{{minutos}}}}{{60}}\right) + \left(\frac{{\text{{segundos}}}}{{3600}}\right)
$$`

===
## [Dependencias](#)

```kotlin
// Google Play Services for Location
implementation("com.google.android.gms:play-services-location:21.0.1")
```

===
## [Permisos - Manifest](#)

```xml
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
```

===
## [Permisos - Compose](#)

```kotlin[]
val lanzadorPermisosUbicacion = 
	rememberLauncherForActivityResult(
	    contract = ActivityResultContracts.RequestMultiplePermissions(),
	    onResult = {
		    if ( it.getOrDefault(Manifest.permission.ACCESS_FINE_LOCATION, false)
		         || 
		         it.getOrDefault(Manifest.permission.ACCESS_COARSE_LOCATION, false)
		    ) {
				// permisos ok, recuperar ubicación
		    } else {
		        // mostrar mensaje error, 
		        // explicación permisos requeridos
		    }
		}
	)
```

===
## [Lanzar Petición - Ejemplo](#)

```kotlin[]
Button(
	onClick = {
		lanzadorPermisosUbicacion.launch(
			arrayOf(
				Manifest.permission.ACCESS_FINE_LOCATION,
				Manifest.permission.ACCESS_COARSE_LOCATION
			)
		)
	}
) {
	Text("Conseguir Ubicación")
}

```

===
Ejemplo con [FusedLocationProviderClient](https://developers.google.com/android/reference/com/google/android/gms/location/FusedLocationProviderClient):

```kotlin[]
val locationTask = fusedLocationProviderClient
	.getCurrentLocation(
		Priority.PRIORITY_HIGH_ACCURACY
		, null
	)
locationTask.addOnSuccessListener {
	onUbicacionOk(it.latitude, it.longitude) 
	// callback definido x usuario
}
locationTask.addOnFailureListener {
	onUbicacionErr()
	// callback definido x usuario
}
```

===
Ejemplo con [LocationManager](https://developer.android.com/reference/android/location/LocationManager):

```kotlin[]
locationManager.getCurrentLocation(
	LocationManager.GPS_PROVIDER,
	null,
	executor,
	Consumer {
		onUbicacionOk(Ubicacion(it.latitude, it.longitude))
	}
)
```

===
## [Corrutinas en Play Services](#)

```kotlin[]
implementation("org.jetbrains.kotlinx:kotlinx-coroutines-play-services:1.7.3")
```

===
## [Convertir fn con Callbacks](#)

```kotlin[]
// Función que utiliza suspendCancellableCoroutine para hacer una operación asíncrona compatible con coroutines
suspend fun operacionAsincronaConCoroutines(): String = 
	suspendCancellableCoroutine { continuation ->
		operacionAsincrona { resultado, error ->
		    if (error != null) {
		        continuation.resumeWithException(error)
		    } else {
		        continuation.resume(resultado ?: "")
		    }
		}

		// Función invokeOnCancellation para limpiar recursos si la coroutine es cancelada
		continuation.invokeOnCancellation {
		    // Puedes realizar acciones de limpieza aquí si es necesario
		}
}
```

===
## [Video Intro](#)

<iframe width="560" height="315" src="https://www.youtube.com/embed/IVRuTxv-b0w?si=20AVffbBWo6WQN3P" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

===
## [Uso - Introducción](#)

<iframe width="560" height="315" src="https://www.youtube.com/embed/PSphVw5Zj38?si=_T43QI9alSxQVZBf" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

===
## [Usando Google Play Services](#)

Con proyecto desde 0 (requisito emulador con Google Play Store):
<iframe width="560" height="315" src="https://www.youtube.com/embed/zlKEUMyapMQ?si=94HkBEnyIrRChurT" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

===
## [Usando Google Play Services](#)

Con Corrutinas (requisito emulador con Google Play Store):

<iframe width="560" height="315" src="https://www.youtube.com/embed/krU4E1DucOo?si=KIj8UFlP4Jkk-C5n" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

===
Diagrama de Secuencia
<!-- .element style="color: white;" -->

![](https://mermaid.ink/img/pako:eNqNks9OwzAMxl-lymmTxgvkMAkNxIU_E1M59eIlXolIk5I4gjHtqXgEXgxvTdeCJkRO0eef7S92dkJ5jUKKiK8JncIrA3WApnIFH1DkQ1HGBMH4g9DJWbiYz5fgCKwFWShrVFGzriEUNUTyHdsTP-CVZ9oQky2GxkQfi7Q2CpT5-nS5taUhqDw700b72AV_FX4y-HbHz7AyG7g59J9MB_hEML3grDWoF6kCAuF5qOzsePeIrY-Gx7CVNdJJvlSUwE5UrjVqdSZz3DT14SGjj40xONY3H_ktC-_KPxOP1NjreBD19GzOMLah262JBMesPGq0EYdF3D_8fxeNjxQgXL-3Njtf5jL9ZtDpQsxEwzIYzZ9wd9ArQc_YYCUkXzVuIFmqROX2jEIiv9o6JSSFhDORWs0rzH9WyA2w2_0368H4Gw?type=png)

===
## [Uso Proyecto Gastos - Introducción](#)

<iframe width="560" height="315" src="https://www.youtube.com/embed/PSphVw5Zj38?si=ujvq-KBFHqiy1YXy" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

===
## [Setup Ejemplo](#)

<iframe width="560" height="315" src="https://www.youtube.com/embed/p2IFwL-OXVs?si=NWWoRts1z9pwrr4D" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

				    </textarea>
				</section>
			</div>
		</div>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/reveal.min.js"></script>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/plugin/notes/notes.min.js"></script>
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/plugin/markdown/markdown.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/5.0.2/plugin/highlight/highlight.min.js"></script>
		<script>			
			Reveal.initialize({
				hash: true,
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealMath.KaTeX ]
			});
			Reveal.on('ready', e => {
				// e.previousSlide, e.currentSlide, e.indexh, e.indexv 				
				const claseSlide = `slide-${e.indexh}-${e.indexv}`
				document.body.className = `reveal-viewport ${claseSlide}`
			});
			Reveal.on('slidechanged', e => {
				// e.previousSlide, e.currentSlide, e.indexh, e.indexv 				
				const claseSlide = `slide-${e.indexh}-${e.indexv}`
				document.body.className = `reveal-viewport ${claseSlide}`
			});
		</script>
	</body>
</html>
